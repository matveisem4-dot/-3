<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Ultra Fix</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; text-align: center; height: 100vh; display: flex; flex-direction: column; }
        #auth { padding: 40px 20px; }
        input { padding: 15px; font-size: 22px; width: 80%; max-width: 250px; border-radius: 12px; border: 2px solid #3b82f6; background: #111; color: white; text-align: center; margin-bottom: 20px; }
        button { padding: 15px 40px; background: #2563eb; color: #fff; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        
        #reader-container { display: none; position: relative; width: 100%; flex-grow: 1; background: #000; }
        #reader { width: 100%; height: 100%; }
        
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ä–∞–º–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞ */
        .scan-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 260px; height: 180px; border: 3px solid #3b82f6; border-radius: 20px; z-index: 10; pointer-events: none; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .laser { position: absolute; top: 10%; left: 5%; width: 90%; height: 2px; background: #ff0000; box-shadow: 0 0 10px #ff0000; animation: move 2s infinite ease-in-out; }
        @keyframes move { 0%, 100% { top: 10%; } 50% { top: 90%; } }

        #status { padding: 20px; font-size: 18px; font-weight: bold; background: #111; border-top: 1px solid #333; }
    </style>
</head>
<body>

    <div id="auth">
        <h2>CONNECT TO KIOSK</h2>
        <input type="number" id="kid" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–∞—Å—Å—ã">
        <br>
        <button onclick="initSystem()">START SCANNER</button>
    </div>

    <div id="reader-container">
        <div id="reader"></div>
        <div class="scan-overlay">
            <div class="laser"></div>
        </div>
    </div>
    
    <div id="status" style="display:none">READY</div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (—Ç–∞ –∂–µ, —á—Ç–æ –≤ –∫–∞—Å—Å–µ)
        const firebaseConfig = { databaseURL: "https://cassa-simulator-4-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let kioskId = "";
        let canScan = true;

        async function initSystem() {
            kioskId = document.getElementById('kid').value;
            if (kioskId.length < 3) { alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID!"); return; }

            document.getElementById('auth').style.display = 'none';
            document.getElementById('reader-container').style.display = 'block';
            document.getElementById('status').style.display = 'block';

            startCamera();
            startNFC();
        }

        function startCamera() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 20, qrbox: { width: 250, height: 150 } };

            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                if (canScan) {
                    sendData(decodedText, "ITEM");
                }
            });
        }

        async function startNFC() {
            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    ndef.onreading = () => {
                        // –ü–æ—Å—ã–ª–∞–µ–º —Å–∏–≥–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –∫–∞—Å—Å–∞ –≤–æ—Å–ø—Ä–∏–º–µ—Ç –∫–∞–∫ –æ–ø–ª–∞—Ç—É
                        sendData("PAY_CONFIRM_777", "NFC");
                    };
                } catch (e) { console.log("NFC support error"); }
            }
        }

        function sendData(code, type) {
            canScan = false;
            const statusEl = document.getElementById('status');
            
            if (navigator.vibrate) navigator.vibrate(100);

            // –í–ù–ò–ú–ê–ù–ò–ï: –ü—É—Ç—å –∑–∞–ø–∏—Å–∏ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π, –∫–∞–∫–æ–π —Å–ª—É—à–∞–µ—Ç —Ç–≤–æ—è –∫–∞—Å—Å–∞!
            // –ú—ã –ø–∏—à–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ kiosks/ID/lastScan
            db.ref('kiosks/' + kioskId).update({
                lastScan: code.toString()
            }).then(() => {
                statusEl.innerText = (type === "NFC" ? "üí≥ PAYMENT SENT" : "üì¶ SENT: " + code);
                statusEl.style.color = "#22c55e";
                
                setTimeout(() => {
                    canScan = true;
                    statusEl.innerText = "READY";
                    statusEl.style.color = "#fff";
                }, 1500);
            });
        }
    </script>
</body>
</html>
