<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro Ultra + NFC</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; text-align: center; overflow: hidden; height: 100vh; }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        #auth { padding-top: 80px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        input { padding: 18px; font-size: 24px; width: 250px; border-radius: 15px; border: 2px solid #3b82f6; background: #111; color: white; text-align: center; outline: none; }
        button { padding: 18px 40px; width: 250px; background: #2563eb; color: #fff; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 18px; }

        /* –û–∫–Ω–æ —Å–∫–∞–Ω–µ—Ä–∞ */
        #reader { display: none; width: 350px; height: 250px; background: #000; border: 4px solid #3b82f6; border-radius: 25px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); overflow: hidden; box-shadow: 0 0 40px rgba(59, 130, 246, 0.3); }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; filter: brightness(1.1) contrast(1.2); }

        /* –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */
        .laser { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: #ff0000; box-shadow: 0 0 15px #ff0000; animation: scanLine 2s infinite ease-in-out; z-index: 10; }
        @keyframes scanLine { 0% { top: 15%; opacity: 0.2; } 50% { top: 85%; opacity: 1; } 100% { top: 15%; opacity: 0.2; } }
        
        .corner { position: absolute; width: 30px; height: 30px; border: 4px solid white; z-index: 11; opacity: 0.7; }
        .top-left { top: 15px; left: 15px; border-right: 0; border-bottom: 0; border-top-left-radius: 10px; }
        .top-right { top: 15px; right: 15px; border-left: 0; border-bottom: 0; border-top-right-radius: 10px; }
        .bottom-left { bottom: 15px; left: 15px; border-right: 0; border-top: 0; border-bottom-left-radius: 10px; }
        .bottom-right { bottom: 15px; right: 15px; border-left: 0; border-top: 0; border-bottom-right-radius: 10px; }

        #status { position: fixed; bottom: 40px; width: 100%; font-weight: bold; font-size: 20px; transition: 0.3s; }
        .nfc-badge { background: #3b82f6; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-top: 10px; display: inline-block; }
    </style>
</head>
<body>

    <div id="auth">
        <h2>CONNECT TO KIOSK</h2>
        <input type="number" id="kid" placeholder="ID: 000000">
        <button onclick="startSystem()">START SYSTEM</button>
    </div>

    <div id="reader">
        <div class="laser"></div>
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>
    </div>
    
    <div id="status">
        WAITING...
        <br><span id="nfc-status" class="nfc-badge">NFC: DISABLED</span>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://cassa-simulator-4-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let canScan = true;
        let kioskId = "";

        // 1. –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ (–ö–ê–ú–ï–†–ê + NFC)
        async function startSystem() {
            kioskId = document.getElementById('kid').value;
            if(kioskId.length < 3) { alert("Invalid ID"); return; }

            document.getElementById('auth').style.display = 'none';
            document.getElementById('reader').style.display = 'block';
            
            startCamera();
            startNFC(); // –í–∫–ª—é—á–∞–µ–º "—É—Ö–æ" –¥–ª—è NFC
        }

        // 2. –†–ê–ë–û–¢–ê –° –ö–ê–ú–ï–†–û–ô
        function startCamera() {
            const scanner = new Html5Qrcode("reader");
            const config = { fps: 25, qrbox: { width: 300, height: 200 } };

            scanner.start({ facingMode: "environment" }, config, (decodedText) => {
                if(canScan) {
                    sendToFirebase(decodedText, "BARCODE");
                }
            });
        }

        // 3. –†–ê–ë–û–¢–ê –° NFC (–¢–æ—Ç —Å–∞–º—ã–π "–∂–µ—Å—Ç–∫–∏–π" —Å–∏–≥–Ω–∞–ª)
        async function startNFC() {
            const nfcLabel = document.getElementById('nfc-status');
            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    nfcLabel.innerText = "NFC: ACTIVE";
                    nfcLabel.style.background = "#22c55e";

                    ndef.onreading = event => {
                        // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω/–∫–∞—Ä—Ç—É - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –æ–ø–ª–∞—Ç—ã
                        sendToFirebase("PAY_CONFIRM_777", "NFC");
                        if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    };
                } catch (error) {
                    nfcLabel.innerText = "NFC: PERMISSION DENIED";
                }
            } else {
                nfcLabel.innerText = "NFC: NOT SUPPORTED";
            }
        }

        // 4. –û–¢–ü–†–ê–í–ö–ê –í –ë–ê–ó–£
        function sendToFirebase(code, type) {
            canScan = false;
            const readerEl = document.getElementById('reader');
            const statusEl = document.getElementById('status');

            // –í–∏–∑—É–∞–ª —É—Å–ø–µ—Ö–∞
            readerEl.style.borderColor = (type === "NFC" ? "#facc15" : "#22c55e");
            statusEl.innerText = (type === "NFC" ? "üí≥ NFC PAYMENT SENT" : "üì¶ ITEM SENT: " + code);
            statusEl.style.color = (type === "NFC" ? "#facc15" : "#22c55e");

            // –ó–∞–ø–∏—Å—å –≤ Firebase
            db.ref('kiosks/' + kioskId).update({ 
                lastScan: code,
                t: Date.now() 
            });

            setTimeout(() => {
                canScan = true;
                readerEl.style.borderColor = "#3b82f6";
                statusEl.innerText = "READY TO SCAN";
                statusEl.style.color = "#fff";
            }, 2000);
        }
    </script>
</body>
</html>
